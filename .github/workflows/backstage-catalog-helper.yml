name: Backstage Catalog Info Helper
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  update-catalog-info:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Actions
        uses: actions/checkout@de5a000abf73b6f4965bd1bcdf8f8d94a56ea815
        with:
          fetch-depth: 0
      - name: Run Backstage Catalog Info Helper
        uses: cds-snc/backstage-catalog-info-helper-action@e36696cef34ed39c43a6e4a3873821bb2bad7eef # v0.3.1
        with:
          github_app_id: ${{ secrets.SRE_BOT_RW_APP_ID }}
          github_app_private_key: ${{ secrets.SRE_BOT_RW_PRIVATE_KEY }}
          github_organization: cds-snc
      - name: impersonate Read/Write GH App
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a
        id: generate_token
        with:
          app_id: ${{ secrets.SRE_BOT_RW_APP_ID }}
          private_key: ${{ secrets.SRE_BOT_RW_PRIVATE_KEY }}
      - name: Create pull request
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v7.0.5
        with:
          token: ${{ steps.generate_token.outputs.token}}
          sign-commits: true
          commit-message: 'Add catalog-info.yaml'
          branch: 'backstage/catalog-info'
          title: 'Add catalog-info.yaml'
          body: 'Adding a basic catalog-info.yaml to start populating the backstage catalog with your components.'
          labels: 'backstage'
          add-paths: |
            catalog-info.yaml